<html>
<head>
  <title>Google Book Words</title>
    <style>
        .answer {
            min-height: 50px
        }
        section{
          padding: 10px;
          margin-bottom: 12px
        }
        #title {
          position: absolute;
          padding: 20px;
          font-size: 64px;
          font-weight: bolder;
          color: white;
          top: 50px;
          left: 0px;
          text-shadow: -2px 0 black, 0 2px black, 5px 0 black, 0 -2px black
        }
        #title .authors {
          padding: 20px;
          font-size: 32px;
          font-weight: bolder;
          color: #DDD;
          text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black
        }
        #tweets {
          min-height: 300px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/tomorrow.min.css">
</head>
<body>

  <div class="parallax-container"  style="height:300px">
    <div class="parallax">
      <img src="http://res.cloudinary.com/craftml/image/upload/c_scale,e_brightness:-62,w_1000/v1447038536/books_nh4k05.jpg">
      <h1 id="title">How did word usage change over time?
        <div class="authors">by Zach Lamb</div>
      </h1>
    </div>
  </div>

  <div class="section white container flow-text">
      <div class="switch">
        Source Code
        <label>
          <input type="checkbox">
          <span class="lever"></span>
        </label>
      </div>

      <div id="questions" class="col s10 collection">
      </div>
  </div>

  <script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
  <script>

function toggleSourecode(){
  $('pre').each(function(){
    if ($(this).height()){
        $(this).attr('data-height', $(this).height())
        $(this).height(0)
    } else {
      $(this).height($(this).attr('data-height'))
    }
  })
}
$('.switch input').click(toggleSourecode)

function csv2jsonArray(rawdata){
  console.log('converting csv to json array')
  var lines = rawdata.trim().split('\n')
  var rows = _.rest(lines)
  return _.map(rows, function(row){
    var toks = row.split(',')
    return {decade: toks[0], word: toks[1], rank: toks[2], count: toks[3]}
  })
}

var items
$.ajax({url: 'https://big-data-hci-hackathon.firebaseapp.com/data/100yr_ngrams_10000.csv'})
 .done(function(rawdata){

  items = csv2jsonArray(rawdata)
  console.log('number of items loaded:', items.length)
  console.log('first item:', items[0])

  analyze()

 })
 .fail(function(err){
     console.error(err)
 })

function ask(text, func){
  var answer = func(items)

  // html element to display the answer
  var answerHtml = '<div class="collection-item answer">' +
      '<h4>' + text + '</h4>' +
      '<div>' + answer + '</div>' +
      '<pre><code>' + func.toString() + '</code></pre>' +
    '</div>'

  // append to #quetions
  $('#questions').append(answerHtml)
}

function analyze(){
  ask('how many decades in the dataset?', example)
  ask('what words were created in recent decades?', func1)
  ask('What is the usage change of the word internet?', func2)
  ask('when did the word oil become more popular than ?', func3)
  ask('what terms saw the biggest drop in popularity over the past century?', func4)
  ask('what terms are most similar to the term war in terms of the changes in popularity?', func5)
  ask('how does the word ,Google, change in popularity over the decades?', func6)
  ask('in which decade was the term oil most used?', func7)
  ask('when did the word feminism become popular?', func8)
  ask('how does the word gay change in popularity over time?', func9)
  ask('what words were only popular in earlier decades?', func10)

  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  })
  toggleSourecode()
}

// How many decades are there in the data set?

function example(){
  return _.unique(_.pluck(items, 'decade')).length
}
// What words only came into fashion in recent decades?

function func1(){
  topItems = _.filter(items, function(i) { return i.rank < 250 })

  topWords = _.chain(topItems)
    .pluck('word')
    .uniq()
    .value()

  oldTopWords = _.chain(topItems)
    .filter(function(i) { return i.decade < 1960 })
    .pluck('word')
    .uniq()
    .value()

  return _.difference(topWords, oldTopWords).join(', ')
}

function func2(){
  decade = _.chain(items)
    .filter({'word': 'internet'})
    .sortBy('decade')
    .value()[0].decade

  words = _.chain(items)
    .groupBy('word')
    .filter(function(w) {
        return _.min(_.values(w), 'decade').decade == decade
    }).map(function(w) { return w[0].word })
    .value().join(', ')

  return words

function func3(){
  oil = _.chain(items)
    .filter({'word': 'electricity'})
    .map(function(i) {return _.pick(i, 'decade', 'rank')})
    .value()

  gold = _.chain(items)
    .filter({'word': 'oil'})
    .map(function(i) {return _.pick(i, 'decade', 'rank')})
    .value()

  decade = _.find(_.zip(oil, gold), function(pair) {
    return parseInt(pair[0].rank) > parseInt(pair[1].rank)
  })[0].decade

  return decade
}

function func4(){
  words = _.chain(items)
    .groupBy('word') 
    .mapValues(function(w) { return w[0].rank - w[w.length-1].rank })
    .pairs()
    .sortBy(function(w) { return w[1] })
    .take(50)
    .value().join('; ')

  return words
}
function func5(){
  warRanks = _.chain(items)
    .filter({'word': 'war'})
    .pluck('rank')
    .value()
  _.forEach(warRanks, function(rank, i) {
    if (i==0) warBitMap = 0
    else {
      bit = (warRanks[i] - warRanks[i-1]) < 0 ? 1 : 0
      warBitMap = warBitMap | bit << (i-1)
    }
  })
  ranks = _.chain(items)
    .groupBy('word')
    .mapValues(function(w) { return _.pluck(_.values(w), 'rank') })
    .pick(function(value) { return value.length == 11 })
    .value()

  // Map value of each word to its' bitmap
  bitMaps = _.mapValues(ranks, function(r, i) {
    _.forEach(r, function(rank, i) {
      if (i==0) bitMap = 0
      else {
        bit = (r[i] - r[i-1]) < 0 ? 1 : 0
        bitMap = bitMap | bit << (i-1)
      }
    })
  return bitMap
  })

  // Find words with bitmaps matching "war's" bitmap
  matches = _.chain(bitMaps)
    .pick(function(bitMap) { return bitMap == warBitMap })
    .keys()
    .without('war')
    .value().join(', ')

  return matches
}

function func6(){
  return _.chain(items)
    .filter({'word': 'google'})
    .sortBy('decade')
    .map(function(entry) {
      return _.chain(entry)
        .pick('decade', 'rank')
        .pairs()
        .flatten()
        .value()
    }).value().join('; ')
}

function func7(){
  return _.chain(items)
    .filter({'word': 'oil'})
    .sortBy(function(entry) { return -entry.count })
    .value()[0].decade
}
function func8(){
  return _.chain(items)
    .filter({'word': 'feminism'})
    .sortBy('decade')
    .value(0)[0].decade
}

function func9(){
  return _.chain(items)
    .filter({'word': 'gay'})
    .sortBy('decade')
    .map(function(entry) {
      return _.chain(entry)
        .pick('decade', 'rank')
        .pairs()
        .flatten()
        .value()
    }).value().join('; ')
}

function func10(){
    topItems = _.filter(items, function(i) { return i.rank < 250 })

    topWords = _.chain(topItems)
      .pluck('word')
      .uniq()
      .value()

    newTopWords = _.chain(topItems)
      .filter(function(i) { return i.decade >= 1960 })
      .pluck('word')
      .uniq()
      .value()

    return _.difference(topWords, newTopWords).join(', ')
}

// initialize the parallax effect
$(document).ready(function(){
    $('.parallax').parallax()
})

    </script>

</body>
</html>